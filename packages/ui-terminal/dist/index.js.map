{"version":3,"file":"index.js","sources":["../src/Terminal.jsx"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\nimport { io } from 'socket.io-client';\nimport { Terminal } from '@xterm/xterm';\nimport { FitAddon } from '@xterm/addon-fit';\nimport '@xterm/xterm/css/xterm.css';\nimport './Terminal.css';\n\n/**\n * Terminal Component\n * @param {Object} props\n * @param {'local' | 'online'} props.mode - Connection mode\n * @param {string} [props.token] - Token for online mode\n * @param {string} [props.wsUrl] - WebSocket server URL for online mode (e.g., 'https://ws.webcc.dev')\n */\nfunction TerminalComponent({ mode = 'local', token = '', wsUrl = '' }) {\n  const terminalRef = useRef(null);\n  const xtermRef = useRef(null);\n  const fitAddonRef = useRef(null);\n  const socketRef = useRef(null);\n  const resizeObserverRef = useRef(null);\n  const [isConnected, setIsConnected] = useState(false);\n  const historyBufferRef = useRef('');\n  const storageKeyRef = useRef('');\n\n  const clearHistory = () => {\n    try {\n      const key = storageKeyRef.current;\n      localStorage.removeItem(key);\n      historyBufferRef.current = '';\n    } catch (error) {\n      console.error('Failed to clear history from localStorage:', error);\n    }\n  };\n\n  useEffect(() => {\n    // Storage configuration\n    const MAX_STORAGE_SIZE = 5 * 1024 * 1024; // 5MB\n    const MAX_LINES = 10000;\n\n    const getStorageKey = () => {\n      if (mode === 'online') {\n        return `terminal-history-online-${token}`;\n      }\n      return 'terminal-history-local';\n    };\n\n    const loadHistory = () => {\n      try {\n        const key = getStorageKey();\n        const history = localStorage.getItem(key);\n        return history || '';\n      } catch (error) {\n        console.error('Failed to load history from localStorage:', error);\n        return '';\n      }\n    };\n\n    const saveHistory = (data) => {\n      try {\n        const key = storageKeyRef.current;\n        let newHistory = historyBufferRef.current + data;\n\n        // Limit by size\n        if (newHistory.length > MAX_STORAGE_SIZE) {\n          newHistory = newHistory.slice(-MAX_STORAGE_SIZE);\n        }\n\n        // Limit by lines (approximate)\n        const lines = newHistory.split('\\n');\n        if (lines.length > MAX_LINES) {\n          newHistory = lines.slice(-MAX_LINES).join('\\n');\n        }\n\n        historyBufferRef.current = newHistory;\n        localStorage.setItem(key, newHistory);\n      } catch (error) {\n        console.error('Failed to save history to localStorage:', error);\n        if (error.name === 'QuotaExceededError') {\n          try {\n            const recentData = data.slice(-MAX_STORAGE_SIZE / 2);\n            historyBufferRef.current = recentData;\n            localStorage.setItem(storageKeyRef.current, recentData);\n          } catch (_) {\n            // ignore cleanup errors\n          }\n        }\n      }\n    };\n\n    // Validate online mode params\n    if (mode === 'online' && (!token || !wsUrl)) {\n      console.error('Token and wsUrl are required for online mode');\n      return;\n    }\n\n    // Initialize storage key\n    storageKeyRef.current = getStorageKey();\n\n    // Create terminal instance\n    const term = new Terminal({\n      cursorBlink: true,\n      fontSize: 14,\n      fontFamily: '\"Cascadia Code\", \"Fira Code\", \"Courier New\", monospace',\n      theme: {\n        background: '#1e1e1e',\n        foreground: '#e8e8e8',\n        cursor: '#6bcf7f',\n        black: '#000000',\n        red: '#ff6b6b',\n        green: '#6bcf7f',\n        yellow: '#ffd93d',\n        blue: '#74b9ff',\n        magenta: '#e066ff',\n        cyan: '#4ecdc4',\n        white: '#e8e8e8',\n        brightBlack: '#888888',\n        brightRed: '#ff6b6b',\n        brightGreen: '#6bcf7f',\n        brightYellow: '#ffd93d',\n        brightBlue: '#74b9ff',\n        brightMagenta: '#e066ff',\n        brightCyan: '#4ecdc4',\n        brightWhite: '#ffffff',\n      },\n      scrollback: 10000,\n      allowProposedApi: true,\n    });\n\n    // Create fit addon\n    const fitAddon = new FitAddon();\n    term.loadAddon(fitAddon);\n\n    // Open terminal\n    term.open(terminalRef.current);\n    fitAddon.fit();\n\n    xtermRef.current = term;\n    fitAddonRef.current = fitAddon;\n\n    // Load and restore history\n    const history = loadHistory();\n    if (history) {\n      historyBufferRef.current = history;\n      term.write(history);\n      // Move cursor to a new line and scroll to bottom after restoring history\n      term.write('\\r\\n');\n      term.scrollToBottom();\n    }\n\n    // Listen for terminal input\n    term.onData((data) => {\n      if (socketRef.current && socketRef.current.connected) {\n        if (mode === 'online') {\n          socketRef.current.emit('cli-input', { token, data });\n        } else {\n          socketRef.current.emit('cli-input', data);\n        }\n      }\n    });\n\n    // Connect to Socket.IO server\n    const socketConfig = { path: '/ws', transports: ['websocket'] };\n    const socket = mode === 'online' ? io(wsUrl, socketConfig) : io(socketConfig);\n    socketRef.current = socket;\n\n    // Socket event handlers\n    const handleConnect = () => {\n      if (mode === 'online') {\n        socket.emit('register', { type: 'browser', token });\n      } else {\n        setIsConnected(true);\n      }\n    };\n\n    const handleRegistered = () => {\n      setIsConnected(true);\n    };\n\n    const handleDisconnect = () => {\n      setIsConnected(false);\n    };\n\n    const handleCliDisconnected = () => {\n      // CLI session ended, just update state\n    };\n\n    const handleConnectError = () => {\n      setIsConnected(false);\n    };\n\n    const handleError = () => {\n      // errors are reflected via disconnect state\n    };\n\n    const handleCliOutput = (data) => {\n      if (data.data) {\n        term.write(data.data);\n        saveHistory(data.data);\n      }\n    };\n\n    // Register socket event listeners\n    socket.on('connect', handleConnect);\n    socket.on('registered', handleRegistered);\n    socket.on('disconnect', handleDisconnect);\n    socket.on('cli-disconnected', handleCliDisconnected);\n    socket.on('connect_error', handleConnectError);\n    socket.on('error', handleError);\n    socket.on('cli-output', handleCliOutput);\n\n    // Use ResizeObserver for terminal resize handling\n    const resizeObserver = new ResizeObserver(() => {\n      requestAnimationFrame(() => {\n        fitAddon.fit();\n      });\n    });\n\n    if (terminalRef.current) {\n      resizeObserver.observe(terminalRef.current);\n      resizeObserverRef.current = resizeObserver;\n    }\n\n    // Cleanup\n    return () => {\n      if (resizeObserverRef.current) {\n        resizeObserverRef.current.disconnect();\n      }\n\n      socket.off('connect', handleConnect);\n      socket.off('registered', handleRegistered);\n      socket.off('disconnect', handleDisconnect);\n      socket.off('cli-disconnected', handleCliDisconnected);\n      socket.off('connect_error', handleConnectError);\n      socket.off('error', handleError);\n      socket.off('cli-output', handleCliOutput);\n      socket.disconnect();\n\n      term.dispose();\n    };\n  }, [mode, token, wsUrl]);\n\n  const clearTerminal = () => {\n    if (xtermRef.current) {\n      xtermRef.current.clear();\n      clearHistory();\n    }\n  };\n\n  return (\n    <div className=\"terminal-app-container\">\n      <div className=\"terminal-app-header\">\n        <div className=\"terminal-header-left\">\n          <h1 className=\"terminal-app-title\">Claude CLI Terminal</h1>\n          <div className=\"terminal-connection-status\">\n            <div className={`terminal-status-indicator ${isConnected ? 'connected' : 'disconnected'}`}></div>\n            <span>{isConnected ? 'Connected' : 'Disconnected'}</span>\n          </div>\n        </div>\n        <div className=\"terminal-header-buttons\">\n          <button onClick={clearTerminal} className=\"terminal-header-button\">\n            Clear Terminal\n          </button>\n        </div>\n      </div>\n      <div ref={terminalRef} className=\"terminal-container\" />\n    </div>\n  );\n}\n\nexport default TerminalComponent;\n"],"names":["_ref","_ref$mode","mode","_ref$token","token","_ref$wsUrl","wsUrl","terminalRef","useRef","xtermRef","fitAddonRef","socketRef","resizeObserverRef","_useState2","_slicedToArray","useState","isConnected","setIsConnected","historyBufferRef","storageKeyRef","useEffect","MAX_STORAGE_SIZE","getStorageKey","concat","current","term","Terminal","cursorBlink","fontSize","fontFamily","theme","background","foreground","cursor","black","red","green","yellow","blue","magenta","cyan","white","brightBlack","brightRed","brightGreen","brightYellow","brightBlue","brightMagenta","brightCyan","brightWhite","scrollback","allowProposedApi","fitAddon","FitAddon","loadAddon","open","fit","history","key","localStorage","getItem","error","console","loadHistory","write","scrollToBottom","onData","data","connected","emit","socketConfig","path","transports","socket","io","handleConnect","type","handleRegistered","handleDisconnect","handleCliDisconnected","handleConnectError","handleError","handleCliOutput","newHistory","length","slice","lines","split","join","setItem","name","recentData","_","saveHistory","on","resizeObserver","ResizeObserver","requestAnimationFrame","observe","disconnect","off","dispose","React","createElement","className","onClick","clear","removeItem","clearHistory","ref"],"mappings":"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"}