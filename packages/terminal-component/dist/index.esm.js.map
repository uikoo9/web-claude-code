{"version":3,"file":"index.esm.js","sources":["../src/Terminal.jsx"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\nimport { io } from 'socket.io-client';\nimport { Terminal } from '@xterm/xterm';\nimport { FitAddon } from '@xterm/addon-fit';\nimport '@xterm/xterm/css/xterm.css';\nimport './Terminal.css';\n\n/**\n * Terminal Component\n * @param {Object} props\n * @param {'local' | 'online'} props.mode - Connection mode\n * @param {string} [props.token] - Token for online mode\n * @param {string} [props.wsUrl] - WebSocket server URL for online mode (e.g., 'https://ws.webcc.dev')\n */\nfunction TerminalComponent({ mode = 'local', token = '', wsUrl = '' }) {\n  const terminalRef = useRef(null);\n  const xtermRef = useRef(null);\n  const fitAddonRef = useRef(null);\n  const socketRef = useRef(null);\n  const resizeObserverRef = useRef(null);\n  const [isConnected, setIsConnected] = useState(false);\n  const historyBufferRef = useRef('');\n  const storageKeyRef = useRef('');\n\n  const clearHistory = () => {\n    try {\n      const key = storageKeyRef.current;\n      localStorage.removeItem(key);\n      historyBufferRef.current = '';\n    } catch (error) {\n      console.error('Failed to clear history from localStorage:', error);\n    }\n  };\n\n  useEffect(() => {\n    // Storage configuration\n    const MAX_STORAGE_SIZE = 5 * 1024 * 1024; // 5MB\n    const MAX_LINES = 10000;\n\n    const getStorageKey = () => {\n      if (mode === 'online') {\n        return `terminal-history-online-${token}`;\n      }\n      return 'terminal-history-local';\n    };\n\n    const loadHistory = () => {\n      try {\n        const key = getStorageKey();\n        const history = localStorage.getItem(key);\n        return history || '';\n      } catch (error) {\n        console.error('Failed to load history from localStorage:', error);\n        return '';\n      }\n    };\n\n    const saveHistory = (data) => {\n      try {\n        const key = storageKeyRef.current;\n        let newHistory = historyBufferRef.current + data;\n\n        // Limit by size\n        if (newHistory.length > MAX_STORAGE_SIZE) {\n          newHistory = newHistory.slice(-MAX_STORAGE_SIZE);\n        }\n\n        // Limit by lines (approximate)\n        const lines = newHistory.split('\\n');\n        if (lines.length > MAX_LINES) {\n          newHistory = lines.slice(-MAX_LINES).join('\\n');\n        }\n\n        historyBufferRef.current = newHistory;\n        localStorage.setItem(key, newHistory);\n      } catch (error) {\n        console.error('Failed to save history to localStorage:', error);\n        if (error.name === 'QuotaExceededError') {\n          try {\n            const recentData = data.slice(-MAX_STORAGE_SIZE / 2);\n            historyBufferRef.current = recentData;\n            localStorage.setItem(storageKeyRef.current, recentData);\n          } catch (_) {\n            // ignore cleanup errors\n          }\n        }\n      }\n    };\n\n    // Validate online mode params\n    if (mode === 'online' && (!token || !wsUrl)) {\n      console.error('Token and wsUrl are required for online mode');\n      return;\n    }\n\n    // Initialize storage key\n    storageKeyRef.current = getStorageKey();\n\n    // Create terminal instance\n    const term = new Terminal({\n      cursorBlink: true,\n      fontSize: 14,\n      fontFamily: '\"Cascadia Code\", \"Fira Code\", \"Courier New\", monospace',\n      theme: {\n        background: '#1e1e1e',\n        foreground: '#e8e8e8',\n        cursor: '#6bcf7f',\n        black: '#000000',\n        red: '#ff6b6b',\n        green: '#6bcf7f',\n        yellow: '#ffd93d',\n        blue: '#74b9ff',\n        magenta: '#e066ff',\n        cyan: '#4ecdc4',\n        white: '#e8e8e8',\n        brightBlack: '#888888',\n        brightRed: '#ff6b6b',\n        brightGreen: '#6bcf7f',\n        brightYellow: '#ffd93d',\n        brightBlue: '#74b9ff',\n        brightMagenta: '#e066ff',\n        brightCyan: '#4ecdc4',\n        brightWhite: '#ffffff',\n      },\n      scrollback: 10000,\n      allowProposedApi: true,\n    });\n\n    // Create fit addon\n    const fitAddon = new FitAddon();\n    term.loadAddon(fitAddon);\n\n    // Open terminal\n    term.open(terminalRef.current);\n    fitAddon.fit();\n\n    xtermRef.current = term;\n    fitAddonRef.current = fitAddon;\n\n    // Load and restore history\n    const history = loadHistory();\n    if (history) {\n      historyBufferRef.current = history;\n      term.write(history);\n    } else {\n      // Write welcome message only if no history\n      term.writeln('\\x1b[1;36mWelcome to Claude CLI Terminal\\x1b[0m');\n      term.writeln('\\x1b[90mConnecting to server...\\x1b[0m\\n');\n    }\n\n    // Listen for terminal input\n    term.onData((data) => {\n      if (socketRef.current && socketRef.current.connected) {\n        if (mode === 'online') {\n          socketRef.current.emit('cli-input', { token, data });\n        } else {\n          socketRef.current.emit('cli-input', data);\n        }\n      }\n    });\n\n    // Connect to Socket.IO server\n    const socketConfig = { path: '/ws', transports: ['websocket'] };\n    const socket = mode === 'online' ? io(wsUrl, socketConfig) : io(socketConfig);\n    socketRef.current = socket;\n\n    // Socket event handlers\n    const handleConnect = () => {\n      if (mode === 'online') {\n        socket.emit('register', { type: 'browser', token });\n      } else {\n        setIsConnected(true);\n        term.writeln('\\x1b[1;32m✓ Connected to server\\x1b[0m');\n        term.writeln('\\x1b[90mStarting Claude CLI...\\x1b[0m\\n');\n      }\n    };\n\n    const handleRegistered = () => {\n      setIsConnected(true);\n      term.writeln('\\x1b[1;32m✓ Connected to server\\x1b[0m');\n      term.writeln('\\x1b[90mWaiting for CLI session...\\x1b[0m\\n');\n    };\n\n    const handleDisconnect = () => {\n      setIsConnected(false);\n      term.writeln('\\n\\x1b[1;31m✗ Disconnected\\x1b[0m');\n    };\n\n    const handleCliDisconnected = () => {\n      term.writeln('\\n\\x1b[1;33m✗ CLI session ended\\x1b[0m');\n    };\n\n    const handleConnectError = (error) => {\n      setIsConnected(false);\n      term.writeln(`\\x1b[1;31m✗ Connection failed: ${error.message}\\x1b[0m`);\n      term.writeln('\\x1b[90mAttempting to reconnect...\\x1b[0m\\n');\n    };\n\n    const handleError = (error) => {\n      term.writeln(`\\x1b[1;31m✗ Error: ${error.message || error}\\x1b[0m\\n`);\n    };\n\n    const handleCliOutput = (data) => {\n      if (data.data) {\n        term.write(data.data);\n        saveHistory(data.data);\n      }\n    };\n\n    // Register socket event listeners\n    socket.on('connect', handleConnect);\n    socket.on('registered', handleRegistered);\n    socket.on('disconnect', handleDisconnect);\n    socket.on('cli-disconnected', handleCliDisconnected);\n    socket.on('connect_error', handleConnectError);\n    socket.on('error', handleError);\n    socket.on('cli-output', handleCliOutput);\n\n    // Use ResizeObserver for terminal resize handling\n    const resizeObserver = new ResizeObserver(() => {\n      requestAnimationFrame(() => {\n        fitAddon.fit();\n      });\n    });\n\n    if (terminalRef.current) {\n      resizeObserver.observe(terminalRef.current);\n      resizeObserverRef.current = resizeObserver;\n    }\n\n    // Cleanup\n    return () => {\n      if (resizeObserverRef.current) {\n        resizeObserverRef.current.disconnect();\n      }\n\n      socket.off('connect', handleConnect);\n      socket.off('registered', handleRegistered);\n      socket.off('disconnect', handleDisconnect);\n      socket.off('cli-disconnected', handleCliDisconnected);\n      socket.off('connect_error', handleConnectError);\n      socket.off('error', handleError);\n      socket.off('cli-output', handleCliOutput);\n      socket.disconnect();\n\n      term.dispose();\n    };\n  }, [mode, token, wsUrl]);\n\n  const clearTerminal = () => {\n    if (xtermRef.current) {\n      xtermRef.current.clear();\n      clearHistory();\n    }\n  };\n\n  return (\n    <div className=\"terminal-app-container\">\n      <div className=\"terminal-app-header\">\n        <div className=\"terminal-header-left\">\n          <h1 className=\"terminal-app-title\">Claude CLI Terminal</h1>\n          <div className=\"terminal-connection-status\">\n            <div className={`terminal-status-indicator ${isConnected ? 'connected' : 'disconnected'}`}></div>\n            <span>{isConnected ? 'Connected' : 'Disconnected'}</span>\n          </div>\n        </div>\n        <div className=\"terminal-header-buttons\">\n          <button onClick={clearTerminal} className=\"terminal-header-button\">\n            Clear Terminal\n          </button>\n        </div>\n      </div>\n      <div ref={terminalRef} className=\"terminal-container\" />\n    </div>\n  );\n}\n\nexport default TerminalComponent;\n"],"names":["TerminalComponent","_ref","_ref$mode","mode","_ref$token","token","_ref$wsUrl","wsUrl","terminalRef","useRef","xtermRef","fitAddonRef","socketRef","resizeObserverRef","_useState2","_slicedToArray","useState","isConnected","setIsConnected","historyBufferRef","storageKeyRef","useEffect","MAX_STORAGE_SIZE","getStorageKey","concat","current","term","Terminal","cursorBlink","fontSize","fontFamily","theme","background","foreground","cursor","black","red","green","yellow","blue","magenta","cyan","white","brightBlack","brightRed","brightGreen","brightYellow","brightBlue","brightMagenta","brightCyan","brightWhite","scrollback","allowProposedApi","fitAddon","FitAddon","loadAddon","open","fit","history","key","localStorage","getItem","error","console","loadHistory","write","writeln","onData","data","connected","emit","socketConfig","path","transports","socket","io","handleConnect","type","handleRegistered","handleDisconnect","handleCliDisconnected","handleConnectError","message","handleError","handleCliOutput","newHistory","length","slice","lines","split","join","setItem","name","recentData","_","saveHistory","on","resizeObserver","ResizeObserver","requestAnimationFrame","observe","disconnect","off","dispose","React","createElement","className","onClick","clear","removeItem","clearHistory","ref"],"mappings":"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"}